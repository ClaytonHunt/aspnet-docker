<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <PropertyGroup>
        <ArtifactsDir>$(MSBuildThisFileDirectory)\artifacts\</ArtifactsDir>
        <ImageListArtifact>$(ArtifactsDir)images.txt</ImageListArtifact>
    </PropertyGroup>

    <Target Name="Clean">
        <RemoveDir Directories="$(ArtifactsDir)" />
    </Target>

    <Target Name="Build" DependsOnTargets="Clean">
        <ItemGroup>
            <SubProjects Include="**/build.proj" Exclude="$(MSBuildThisFile)" />
        </ItemGroup>

        <MSBuild Projects="%(SubProjects.Identity)"
                 Targets="Build">
            <Output TaskParameter="TargetOutputs" ItemName="Images" />
        </MSBuild>

        <Message Text="Images created: @(Images, '%0A - ')" Importance="High" />
        <MakeDir Directories="$(ArtifactsDir)" />
        <WriteLinesToFile File="$(ImageListArtifact)" Lines="@(Images)" Overwrite="true" />
    </Target>

    <Target Name="RemoveImages">
        <Message Text="Attempt to remove images: @(Images, '%0A - ')" Importance="High" />
        <Exec Command="docker rmi %(Images.Identity)" IgnoreExitCode="true" />
    </Target>

    <Target Name="PostBuildClean"
            DependsOnTargets="RemoveImages"
            AfterTargets="Build"
            Condition="'$(KeepImages)'=='false'" />

    <Target Name="Publish">
        <Message Text="Attempt to publish images: @(Images, '%0A - ')" Importance="High" />
        <Exec Command="docker push %(Images.Identity)" />
        <Message Text="Publish done" Importance="High"/>
    </Target>

    <Target Name="PostPublishClean"
            DependsOnTargets="RemoveImages"
            AfterTargets="Publish"
            Condition="'$(KeepImages)'!='true'" />
</Project>